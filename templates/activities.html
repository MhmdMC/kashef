<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>جميع النشاطات</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <style>
      body {
        text-align: right;
      }
      .collapse-card {
        background: #f8f9fa;
        padding: 1rem;
        margin: 0.25rem 0 0.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .collapse-card p {
        margin: 0.25rem 0;
      }
      .collapse-card .paragraphs {
        white-space: pre-wrap;
      }
      .table td,
      .table th {
        vertical-align: middle;
      }
      input,
      select,
      button {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      /* Fix dropdown arrow overlap in RTL */
      .choices[data-type*="select-one"]::after {
        left: 11px;
        right: auto;
      }
      .choices[data-type*="select-one"] .choices__inner {
        padding-right: 0.75em;
      }

      /* Hidden inputs exactly behind selects */
      .hidden-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
        margin: 0;
        padding: 0;
        border: none;
        display: none;
      }
      .select-wrapper {
        position: relative;
      }

      .select-wrapper .choices {
        width: 100% !important;
      }

      .select-wrapper .choices__inner {
        box-sizing: border-box; /* include padding/border in width */
      }
      .submit-btn {
        background: #28a745;
        color: white;
        border: none;
        min-width: 10em;
      }
      /* site-nav: sticky horizontal bar with consistent sizing across pages */
      .site-nav {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 1100;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
        box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      }
      .site-nav .nav-inner {
        width: 100%;
        padding: 8px 14px;
        min-height: 48px; /* consistent height */
        display: flex;
        direction: rtl; /* ensure visual right alignment in RTL pages */
        justify-content: flex-start; /* with direction:rtl this pushes items to the visual right */
        gap: 12px;
        align-items: center;
        box-sizing: border-box;
        font-size: 16px;
      }
      .site-nav a {
        color: #0d6efd;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-block;
      }
      .site-nav a:hover {
        background: rgba(13, 110, 253, 0.08);
      }
      .footer {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #666;
      }
      #admin {
        opacity: 0;
      }
      #adminFilter {
        display: none;
      }
    </style>
  </head>
  <body class="p-2 p-md-4">
    <nav class="site-nav">
      <div class="nav-inner">
        <!-- activities page: only show link to index -->
        <a href="{{ url_for('index') }}">أضف نشاط</a>
      </div>
    </nav>
    <div class="container-fluid px-2 px-md-4">
      <h1 class="mb-3 mb-md-4">جميع الأنشطة</h1>

      <!-- submit as GET so inputs persist in URL after submit -->
      <form method="POST" action="{{ url_for('activities') }}">
        <div class="mb-3 row align-items-end g-2">
          <div>
            <select id="group" name="group" class="form-select w-100">
              <option {% if current_group == "" or current_group == "كل الفرق" %}selected{% endif %}>كل الفرق</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/مرحلة البراعم" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/مرحلة البراعم</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/مرحلة الاشبال" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/مرحلة الاشبال</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/مرحلة الكشافة" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/مرحلة الكشافة</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/مرحلة الجوالة" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/مرحلة الجوالة</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/امانة التدريب" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/امانة التدريب</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/امانة السر" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/امانة السر</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/امانة الفنون" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/امانة الفنون</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/امانة الموارد البشرية" %}selected{% endif %}>
                فوج الامام الباقر (ع)/ تفاحتا/امانة الموارد البشرية
              </option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/امانة الاعلام" %}selected{% endif %}>فوج الامام الباقر (ع)/ تفاحتا/امانة الاعلام</option>
              <option {% if current_group == "فوج الامام الباقر (ع)/ تفاحتا/فرقة الخدمة المجتمعية" %}selected{% endif %}>
                فوج الامام الباقر (ع)/ تفاحتا/فرقة الخدمة المجتمعية
              </option>
            </select>
          </div>

          <div>
            <input
              type="text"
              id="q"
              name="q"
              placeholder="ابحث عن نشاط عبر الID او نوعه او احدى فقراته..."
              class="form-control w-100"
              value="{{ current_q }}"
            />
          </div>

          <!-- Date Filter Buttons -->
          <div class="mb-3 d-flex flex-wrap align-items-end gap-4">
            <!-- Prebuilt buttons -->
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-primary" id="last3Btn">
                آخر 3 أيام
              </button>
              <button type="button" class="btn btn-secondary" id="last7Btn">
                آخر 7 أيام
              </button>
              <button type="button" class="btn btn-info" id="last30Btn">
                آخر 30 يوم
              </button>
            </div>

            <!-- Custom range -->
            <div class="d-flex flex-wrap gap-4 align-items-center">
              <label class="mb-0" for="customFrom">من:</label>
              <input
                type="date"
                id="customFrom"
                name="start"
                class="form-control"
                style="width: auto"
                value="{{ current_start }}"
              />
              <label class="mb-0" for="customTo">إلى:</label>
              <input
                type="date"
                id="customTo"
                name="end"
                class="form-control"
                style="width: auto"
                value="{{ current_end }}"
              />
              <button type="submit" class="submit-btn">إذهب</button>
              <input type="text" name="admin" id="admin" value="{{ admin }}">
              <select id="adminFilter" name="adminFilter" class="form-select w-auto">
                <option {% if admin_filter == "الكل" %}selected{% endif %}>الكل</option>
                <option {% if admin_filter == "غير مضاف" %}selected{% endif %}>غير مضاف</option>
                <option {% if admin_filter == "مضاف" %}selected{% endif %}>مضاف</option>
                <option {% if admin_filter == "معدل بعد الإضافة" %}selected{% endif %}>معدل بعد الإضافة</option>
              </select>

            </div>
          </div>
        </div>
      </form>

      <!-- Activities Table -->
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>الحالة</th>
            <th>ID</th>
            <th>التاريخ</th>
            <th>المجموعة</th>
            <th>نوع النشاط</th>
            <th>تعديل</th>
            <th>حذف</th>
            <!-- New column header -->
            <th>عرض</th>
          </tr>
        </thead>
        <tbody>
          {% for act in activities %}
          <tr data-checked="{{ act[17] if act[17] is not none else 0 }}">
            <td class="status-cell">
              <button class="status-dot" data-id="{{ act[0] }}" aria-label="status">
                <!-- dot color controlled by data-checked attribute -->
              </button>
            </td>
            <td>{{ act[0] }}</td>
            <td>{{ act[1] }}</td>
            <td>{{ act[2] }}</td>
            <td>{{ act[3] }}</td>
            <td>
              <a
                href="{{ url_for('edit_activity', activity_id=act[0]) }}"
                class="btn btn-sm btn-warning"
                >تعديل</a
              >
            </td>
            <td>
              <form
                action="{{ url_for('delete_activity', activity_id=act[0]) }}"
                method="POST"
                style="display: inline-block"
                onsubmit="return confirm('هل أنت متأكد من حذف هذا النشاط؟');"
              >
                <button type="submit" class="btn btn-sm btn-danger">حذف</button>
              </form>
            </td>
            <td>
              <button
                class="btn btn-sm btn-info"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#details{{ act[0] }}"
                aria-expanded="false"
                aria-controls="details{{ act[0] }}"
              >
                عرض
              </button>
            </td>
          </tr>

          <tr>
            <td colspan="8" class="p-0">
              <div class="collapse" id="details{{ act[0] }}">
                <div class="collapse-card">
                  <p><strong>المكان:</strong> {{ act[6] }}</p>
                  <p><strong>الوقت:</strong> {{ act[4] }}</p>
                  <p>
                    <strong>القادة:</strong> {{ act[7] }},
                    <strong>الجوالة:</strong> {{ act[8] }},
                    <strong>الكشافة:</strong> {{ act[9] }},
                    <strong>الأشبال:</strong> {{ act[10] }},
                    <strong>البراعم:</strong> {{ act[11] }},
                    <strong>غير الكشافة:</strong> {{ act[12] }}
                  </p>
                  <p><strong>المناسبة:</strong> {{ act[5] }}</p>
                  <p>
                    <strong>الفقرات:</strong><br /><span class="paragraphs"
                      >{{ act[13] }}</span
                    >
                  </p>
                  <p><strong>التكلفة:</strong> {{ act[14] }}</p>
                  <p><strong>تاريخ الإنشاء:</strong> {{ act[15] }}</p>
                  <p><strong>تاريخ التعديل:</strong> {{ act[16] }}</p>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="footer">
      فوج الإمام الباقر<sup>(ع)</sup> - تفاحتا - أمانة السّر
    </div>
    <div class="footer">جميع الحقوق محفوظة © 2025</div>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .status-dot{
        width:18px;
        height:18px;
        border-radius:50%;
        border:2px solid rgba(0,0,0,0.06);
        background: #ccc;
        display:inline-block;
        vertical-align:middle;
        cursor:pointer;
      }
      .status-dot.green{ background: #28a745; }
      .status-dot.red{ background: #dc3545; }
      .status-dot.yellow{ background: #ffc107; }
      td.status-cell{ width:54px; }
    </style>
    <script>
      // status dots: color mapping and admin visibility
      function setDotState(dot, checked){
        dot.classList.remove('green','red','yellow');
        if(checked === 1 || checked === '1') dot.classList.add('green');
        else if(checked === 0 || checked === '0') dot.classList.add('red');
        else if(checked === -1 || checked === '-1') dot.classList.add('yellow');
        else dot.classList.add('red');
        dot.dataset.checked = String(checked);
      }

      function initStatusDots(){
        const dots = document.querySelectorAll('.status-dot');
        dots.forEach(dot =>{
          const id = dot.dataset.id;
          const row = dot.closest('tr');
          const checkedVal = row ? row.dataset.checked : null;
          setDotState(dot, checkedVal !== null ? parseInt(checkedVal) : 0);

          dot.addEventListener('click', async (e)=>{
            // if not admin, ignore
            const adminInput = document.getElementById('admin');
            if(!adminInput || !adminInput.value.includes('admin')){
              alert('صلاحيات المسؤول مطلوبة');
              return;
            }

            try{
              const res = await fetch(`/toggle_checked/${id}`, { method: 'POST' });
              const data = await res.json();
              if(data && data.success){
                setDotState(dot, data.checked);
                // also update row dataset so subsequent checks are consistent
                if(row) row.dataset.checked = String(data.checked);
              } else {
                alert('فشل تغيير الحالة');
              }
            }catch(err){
              console.error(err);
              alert('خطأ في الشبكة');
            }
          });
        });
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        // annotate each row with checked value from server-side data
        document.querySelectorAll('tbody tr').forEach((tr, idx)=>{
          // Each activity row corresponds to activities[idx]
        });
        initStatusDots();
        // show/hide status column based on admin input
        const adminInput = document.getElementById('admin');
        function updateStatusVisibility(){
          const show = adminInput && adminInput.value && adminInput.value.includes('admin');
          document.querySelectorAll('.status-cell').forEach(td => td.style.display = show ? '' : 'none');
          document.querySelectorAll('th')[0].style.display = show ? '' : 'none';

          adminInput.style.display = show ? 'none' : 'inline-block';
          document.getElementById('adminFilter').style.display = show ? 'inline-block' : 'none';
        }
        if(adminInput){
          adminInput.addEventListener('input', updateStatusVisibility);
          updateStatusVisibility();
        }
      });

      // Only allow one collapse open at a time
      const collapseElements = document.querySelectorAll(".collapse");
      collapseElements.forEach((el) => {
        el.addEventListener("show.bs.collapse", () => {
          collapseElements.forEach((other) => {
            if (other !== el) {
              bootstrap.Collapse.getInstance(other)?.hide();
            }
          });
        });
      });

      const todayStr = "{{ today }}"; // from server
      const today = new Date(todayStr);
      const customFromInput = document.getElementById("customFrom");
      const customToInput = document.getElementById("customTo");

      function formatDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function fillCustomInputs(daysBackStart, daysBackEnd = 0) {
        const start = new Date(today);
        start.setDate(today.getDate() - daysBackStart);
        const end = new Date(today);
        end.setDate(today.getDate() - daysBackEnd);

        customFromInput.value = formatDate(start);
        customToInput.value = formatDate(end);
      }

      // Fill last 3 days on page load
      window.addEventListener("DOMContentLoaded", () => {
        fillCustomInputs(2, 0);

        // set current group value so Choices reads it
        try {
          const currentGroup = "{{ current_group|e }}";
          if (currentGroup) {
            document.getElementById("group").value = currentGroup;
          }
        } catch (e) {
          console.warn("Could not set group value:", e);
        }

        const groupChoice = new Choices("#group", {
          searchEnabled: true,
          placeholder: true,
          searchPlaceholderValue: "ابحث...",
          shouldSort: false,
        });
      });

      // Buttons fill the custom inputs
      document
        .getElementById("last3Btn")
        .addEventListener("click", () => {
          fillCustomInputs(2, 0);
          document.querySelector("form").submit();
        });
      document
        .getElementById("last7Btn")
        .addEventListener("click", () => {
          fillCustomInputs(6, 0);
          document.querySelector("form").submit();
        });
      document
        .getElementById("last30Btn")
        .addEventListener("click", () => {
          fillCustomInputs(29, 0);
          document.querySelector("form").submit();
        });

      
      // removed broken goCustom handler; form submit will send POST and server uses request.values
    </script>
  </body>
</html>
  </body>
</html>
